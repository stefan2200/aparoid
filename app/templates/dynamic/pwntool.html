{% extends 'layout.html' %}
{% block styles %}
<link rel="stylesheet" href="/static/highlight.js/styles/default.min.css">
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-lg-4">
            <strong>{{ application.name }} - {{ application.identifier }}</strong>
            <button class="btn btn-secondary btn-block" onclick="spawn_application()">(Re)Spawn application</button>
            <input type="checkbox" id="kafka-running"> Report to Kafka
            <button class="btn btn-danger btn-block" onclick="kill_application()">Terminate application</button>
            <hr />
            <strong>Proxy server</strong>
            <p>The proxy server intercepts HTTP(S) requests from the device.</p>
            {% if proxy_running %}
                <button class="btn btn-danger btn-block" onclick="kill_proxy()">Stop proxy</button>
            {% else %}
                <button class="btn btn-success btn-block" onclick="start_proxy()">Start proxy</button>
            {% endif %}
            <strong>Certificate</strong>
            <br />
            {% if certificate %}
            <p class="text-info">{{ certificate }}</p>
            <button class="btn btn-info btn-block" onclick="install_certificate()">(Re)install certificate</button>
            <button class="btn btn-danger btn-block" onclick="remove_certificate()">Remove certificate</button>
            {% else %}
            <p class="text-danger">CA cert not found, this will be automatically generated by the proxy.</p>
            {% endif %}
            <strong>Device proxy</strong>
            <br />
            {% if not proxy_enabled %}
            <button class="btn btn-info btn-block" onclick="enable_proxy()">Enable device proxy</button>
            {% else %}
            <p class="text-success">Proxy server on device: {{ proxy_enabled }}</p>
            <p class="text-success">ADB reverse forward device:8088->host:8088</p>
            <button class="btn btn-danger btn-block" onclick="disable_proxy()">Remove device proxy</button>
            {% endif %}
            <strong>Proxy request parser</strong>
            <p>The proxy collector loads raw requests and responses from Kafka and runs security checks on them.</p>
            <br />
            {% if not collector_running %}
            <button class="btn btn-success btn-block" onclick="start_collector()">Enable proxy collector</button>
            {% else %}
            <p class="text-success">Collector running with pid: {{ collector_running }}</p>
            <button class="btn btn-danger btn-block" onclick="kill_collector()">Disable device collector</button>
            {% endif %}

            <a href="{{ url_for('get_http_requests', application=application.identifier) }}" class="btn btn-block btn-warning" target="_blank">View live requests</a>
            <a href="{{ url_for('read_fs_for', device_type=device_type, application=application.identifier) }}" class="btn btn-primary btn-block">Browse filesystem <i class="fas fa-folder"></i> </a>
             <a href="{{ url_for('get_frida_logs', application=application.identifier) }}" class="btn btn-primary btn-block">Frida logs</i> </a>
        </div>

        <div class="col-lg-8">
            <form method="post" action="{{ url_for('frida_build_scripts', device_type=device_type, device_uuid=device_uuid, application=application.identifier) }}">
            <div class="form-check">
              <input class="form-check-input" name="ssl_unpin" type="checkbox" value="1" id="bypass_ssl_pin">
              <label class="form-check-label" for="bypass_ssl_pin">
                Bypass SSL pinning
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" name="root_bypass" type="checkbox" value="1" id="bypass_root_check">
              <label class="form-check-label" for="bypass_root_check">
                Bypass root detection
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" name="debug_bypass" type="checkbox" value="1" id="bypass_debug">
              <label class="form-check-label" for="bypass_debug">
                Bypass debug detection
              </label>
            </div>
            <textarea name="script_data" class="form-control" rows="8" placeholder="Enter custom script data"></textarea>
                <br />
                <input type="submit" class="btn btn-info btn-block" value="Build scripts">
            </form>
            <hr />
            Current Script:
            <pre><code>{{ frida_blob }}</code></pre>
        </div>
    </div>
{% endblock content %}

{% block subscripts %}
<script src="/static/highlight.js/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<script>
    function start_proxy() {
        $.getJSON('{{ url_for('dynamic_start_proxy', application=application.identifier) }}', function(data){
            if(!data.status) {
                alert("Unable to start proxy. Please consult the application logs for more details");
            } else { window.location.reload(); }
        });
    }
    function kill_proxy() {
        $.getJSON('{{ url_for('dynamic_stop_proxy', application=application.identifier) }}', function(data){
            if(!data.status) {
                alert("Unable to kill proxy. Please consult the application logs for more details");
            } else { window.location.reload(); }
        });
    }

    function start_collector() {
        $.getJSON('{{ url_for('dynamic_start_collector', application=application.identifier) }}', function(data){
            if(!data.status) {
                alert("Unable to start collector. Please consult the application logs for more details");
            } else { window.location.reload(); }
        });
    }
    function kill_collector() {
        $.getJSON('{{ url_for('dynamic_stop_collector', application=application.identifier) }}', function(data){
            if(!data.status) {
                alert("Unable to kill collector. Please consult the application logs for more details");
            } else { window.location.reload(); }
        });
    }

    function install_certificate() {
        $.getJSON('{{ url_for('dynamic_install_cert', device_type=device_type, device_uuid=device_uuid) }}', function(data){
            if(!data.status) {
                alert("Error installing certificate, please check application logs");
            } else {
                if("{{ device_type }}" == "systemless") {
                    if (confirm('Systemless root requires the device to be rebooted after deploying a new certificate. Reboot now?')) {
                        setTimeout(function() {
                            $.getJSON('{{ url_for('adb_reboot', device_uuid=device_uuid) }}', function(data){
                                document.location = '{{ url_for('dynamic_rooted_setup', device_type=device_type) }}';
                            });
                        }, 100);
                    } else {
                        window.location.reload();
                    }
                }
             }
        });
    }

    function spawn_application() {
        var base_url = "{{ url_for('spawn_frida_application', device_uuid=device_uuid, application=application.identifier) }}";
        if($('#kafka-running').is(":checked")) {
            base_url += "?async=1";
        }
        $.getJSON(base_url, function(data){
            if(!data.status) {
                alert("Error installing certificate, please check application logs");
            } else {  }
        });
    }

    function kill_application() {
        var kill_url = '{{ url_for('frida_kill_application', device_uuid=device_uuid, application=application.name) }}';
        $.getJSON(kill_url, function(data){
            if(!data.status) {
                alert(data.error);
            } else {
                window.location.reload();
            }
        });
    }

    function remove_certificate() {
        $.getJSON('{{ url_for('dynamic_remove_cert', device_type=device_type, device_uuid=device_uuid) }}', function(data){
            if(!data.status) {
                alert("Error removing certificate, please check application logs");
            } else { window.location.reload(); }
        });
    }

    function enable_proxy() {
        $.getJSON('{{ url_for('dynamic_enable_device_proxy', device_type=device_type, device_uuid=device_uuid) }}', function(data){
            if(!data.status) {
                alert("Error enabling device proxy, please check application logs");
            } else { window.location.reload(); }
        });
    }
    function disable_proxy() {
        $.getJSON('{{ url_for('dynamic_disable_device_proxy', device_type=device_type, device_uuid=device_uuid) }}', function(data){
            if(!data.status) {
                alert("Error disabling device proxy, please check application logs");
            } else { window.location.reload(); }
        });
    }
</script>
{% endblock %}